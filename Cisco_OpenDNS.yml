commonfields:
  id: Cisco_OpenDNS
  version: -1
name: Cisco_OpenDNS
display: Cisco_OpenDNS
category: Network Security
image: data:image/png;base64,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
description: This is the Hello World integration for getting started.
detaileddescription: |-
  ## Hello World
  - This text is markdown
  - Here you should explain how to configure the instance in Demisto
configuration:
- display: Server URL (e.g. https://example.net)
  name: url
  defaultvalue: https://s-platform.api.opendns.com/1.0/
  type: 0
  required: true
- display: API Key
  name: APIKey
  defaultvalue: ""
  type: 0
  required: true
- display: Trust any certificate (not secure)
  name: insecure
  defaultvalue: ""
  type: 8
  required: false
- display: Use system proxy settings
  name: proxy
  defaultvalue: ""
  type: 8
  required: false
script:
  script: |2+

    ''' Created by Osama Shenoda contact osama.samaan.hanna@gmail.com '''

    ''' IMPORTS '''

    import json
    import requests
    import dateparser

    # Disable insecure warnings
    requests.packages.urllib3.disable_warnings()

    #domain='baddomain.org'
    #baseurl='https://s-platform.api.opendns.com/1.0/events?customerKey='
    #APIKey='ddedd9a6-aea9-471e-95ad-9e22333c1889'



    def OpenDNSgetBlackList(myDomainsrequest):
        #print("inside get list")
        #print("url ",myDomainsrequest)
        r=requests.get(myDomainsrequest)
        r_j=r.json()
        #print(r_j.keys())
        metadata=r_j["meta"]
        mydata=r_j["data"]
        #print(type(mydata))
        #print(metadata)
        nextPage=r_j["meta"]["next"]
        #print(nextPage)
        while nextPage:
            r=requests.get(nextPage)
            r_j=r.json()
            #print(r_j.keys())
            metadata=r_j["meta"]
            mydata.extend(r_j["data"])
            #print(metadata)
            nextPage=r_j["meta"]["next"]
            #print(nextPage)
        i=0
        finalData=[]
        while i < len(mydata):
            finalData.append(mydata[i]["name"])
            i=i+1
        return finalData

    def OpenDNScheckDomainInBlackList(myDomainsrequest, domain):
        blist=OpenDNSgetBlackList(myDomainsrequest)
        if domain in blist:
            return "exists"
        else:
            return "NotExist"


    def OpenDNSblockDomain(myDomainsrequest, myEventsrequest, domain):
        """
            PARSE AND VALIDATE INTEGRATION PARAMS
        """
        #print("durl: ",myDomainsrequest)
        #print("domain :",domain)
        checkStatus=OpenDNScheckDomainInBlackList(myDomainsrequest, domain)
        print("Status : ",checkStatus)
        if  checkStatus == "NotExist":

                myobj={
                "alertTime": "2020-01-13T11:14:26.0Z",
                "deviceId": "ba6a59f4-e692-4724-ba36-c28132c761de",
                "deviceVersion": "13.7a",
                "dstDomain": str(domain),
                "dstUrl": "http://"+str(domain)+"/a-bad-url",
                "eventTime": "2020-01-13T13:30:26.0Z",
                "protocolVersion": "1.0a",
                "providerName": "Security Platform"
                }

                #print("my object : ", myobj)
                r2=requests.post(myEventsrequest, json=myobj, verify=False)
                r2_j=r2.json()
                r_code=r2.status_code
                ##r_code ==>
                ##202 Accepted—Everything worked as expected.
                ##400 Bad Request—Likely missing a required parameter or malformed JSON. Please check the syntax on your query.
                ##403 Unauthorized—Request had Authorization header but token was missing or invalid. Please ensure your API token is valid.
                ##404 Not Found—The requested item doesn't exist, check the syntax of your query or ensure the IP and/or domain are valid. If deleting a domain, ensure the id is correct.
                ##500, 502, 503, 504 Server errors—Something went wrong on our end.
                if int(r_code) == 202:
                    ActionResult="Success"
                else:
                    ActionResult="Failed"

                #print("Result :", r2_j)
                #print("Response Code :", r_code)

                human_readable_data = {
                'Domain': str(domain),
                'Action Result Code': r_code,
                'Response :': r2_j['id'],
                'ActionResult': ActionResult
                    }

                outputs = {
                    'OpenDNSblockDomain': {
                    'Domain': str(domain),
                    'Action Result Code': r_code,
                    'Response :': r2_j['id'],
                    'ActionResult': ActionResult
                        }
                    }

                headers = ['Domain', 'Action Result Code', 'Response', 'ActionResult' ]
                human_readable = tableToMarkdown('OpenDNSblockDomain info' , human_readable_data, headers=headers, removeNull=True)
                return_outputs(human_readable, outputs, r2_j)
        else:
                human_readable_data = {
                'Domain': str(domain),
                'Action Result Code': "Already Blocked",
                'Response :': "Already Blocked",
                'ActionResult': "Already Blocked"
                    }

                outputs = {
                    'OpenDNSblockDomain': {
                    'Domain': str(domain),
                    'Action Result Code': "Already Blocked",
                    'Response :': "Already Blocked",
                    'ActionResult': "Already Blocked"
                        }
                    }

                headers = ['Domain', 'Action Result Code', 'Response', 'ActionResult' ]
                human_readable = tableToMarkdown('OpenDNSblockDomain info' , human_readable_data, headers=headers, removeNull=True)
                return_outputs(human_readable, outputs)


    def OpenDNSdeleteDomain(myDomainsrequest, myEventsrequest, domain):
        #print("we are inside del function")
        delRequest=myDomainsrequest+"&where[name]="+str(domain)
        #print("delRequest ",delRequest)
        r3=requests.delete(delRequest, timeout=2.50)
        #r3_txt=r3.json()
        #print("Response  ", r3_txt)
        r_code=r3.status_code
        print("delRequest status ",r_code)
        if int(r_code) == 204:
            print(domain+" Domain was removed from blacklist")
        else:
            print(domain+" Not in the blacklist or Error")

    def main():

        domain=demisto.args().get('domain')
        baseurl=demisto.params().get('url')
        APIKey=demisto.params().get('APIKey')
        myEventsrequest=str(baseurl)+"events?customerKey="+str(APIKey)
        myDomainsrequest=str(baseurl)+"domains?customerKey="+str(APIKey)
        #print(myDomainsrequest)
        try:
            if demisto.command() == 'OpenDNSblockDomain':
                OpenDNSblockDomain(myDomainsrequest, myEventsrequest, domain)
            elif demisto.command() == 'OpenDNSgetBlackList':
                OpenDNSgetBlackList(myDomainsrequest)
            elif demisto.command() == 'OpenDNScheckDomainInBlackList':
                OpenDNScheckDomainInBlackList(myDomainsrequest, domain)
            elif demisto.command() == 'OpenDNSdeleteDomain':
                OpenDNSdeleteDomain(myDomainsrequest, myEventsrequest, domain)
        except Exception as e:
            return_error(str(e))


    if __name__ in ('__main__', '__builtin__', 'builtins'):
        main()

  type: python
  commands:
  - name: OpenDNSblockDomain
    arguments:
    - name: domain
      required: true
      default: true
      description: Domain
    description: Open DNS  Block Domain
  - name: OpenDNSgetBlackList
    arguments: []
    description: Gel List of all Blaclist Items
  - name: OpenDNScheckDomainInBlackList
    arguments:
    - name: domain
      required: true
      description: Domain
    description: Check if Domain already exist on the Blacklist
  - name: OpenDNSdeleteDomain
    arguments:
    - name: domain
      required: true
      description: Domainto be deleted
  dockerimage: demisto/python3:3.7.4.2245
  runonce: true
  subtype: python3
sourcemoduleid: IPQualityScore
